\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{brumaltex3}[2024/01/07]
\ProvidesExplPackage{brumaltex3}{2024-01-07}{}{}

\RequirePackage{functional}[2023-01-07]
\Functional{scoping=true}

\prgNewFunction \prgNewFunction:Mnn {Mnn}
    {\prgNewFunction #1 {#2} {#3}}

% Delete a function which has been previously defined by \prgNewFunction.
\prgNewFunction \__brt_fun_del {M}
    {\cs_undefine:N #1
     \cs_undefine:c {__fun_defined_ \cs_to_str:N #1 : w}}

% the quantity of objects allocated by makers
\int_new:N \g__brt_heap_size

% {} -> a new unique csname
\prgNewFunction \__brt_heap_alloc {}
    {\tlSet \lTmpaTl {\expName {c__brt_heap_ \int_use:N \g__brt_heap_size}}
     \int_gincr:N \g__brt_heap_size
     \prgReturn {\tlUse \lTmpaTl}}

% #1 = constant constructor; #2 = value; -> new constant
\prgNewFunction \__brt_make {Nm}
    {\tlSet \lTmpaTl {\__brt_heap_alloc}
     #1 {\tlUse \lTmpaTl} {#2}
     \prgReturn {\tlUse \lTmpaTl}}

% \brtPFunCons #1=name:csname {#2=code} -> void
% Make a function that takes one formal parameter which is a keyval list.
% The code must use \prgReturn to return.
% Inside the code, the macro \brtArgGet  may be used to access arguments.
% All argument values are token lists.
\propClearNew \l__args
\prgNewFunction \brtArgGet {m} {\propVarItem \l__args {#1}}
\prgNewFunction \brtPFunCons {Mn}
    {\prgNewFunction #1 {m}
        {\propSetFromKeyval \l__args {##1}
         #2}}

% the quantity of objects with id
\int_new:N \g__brt_universe_size

% \__brt_id_alloc -> new unique id string
\strClearNew \l__id
\prgNewFunction \__brt_id_alloc {}
    {\strSet \l__id {\evalWhole {brt Id \intUse \g__brt_universe_size}}
     \int_gincr:N \g__brt_universe_size
     \prgReturn {\strUse \l__id}}

% \brtObjCons {#2=args:keyvals} -> new object
% If args does not provide @type=, then the object's @type is set to \brtTypeT.
% The object is automatically given an @id=, which overrides args.@id.
% The @id= also serves as a name.
% TODO Handle primitives.
\propClearNew \l__args
\strClearNew \l__id
\tlClearNew \l__obj_p
\prgNewFunction \brtObjCons {m}
    {\propSetFromKeyval \l__args {\evalWhole {#1}}
     \strSet \l__id {\__brt_id_alloc}
     \propPutIfNew \l__args {@type} {\brtTypeT}
     \propPut \l__args {@id} {\strUse \l__id}
     \tlSet \l__obj_p {\__brt_make \propConstFromKeyval {\propToKeyval \l__args}}
     \brtObjName {\strUse \l__id} {\tlUse \l__obj_p}
     \prgReturn {\tlUse \l__obj_p}}

% \brtObjElim #1=obj:obj {#2=key:str} -> value
% TODO support attribute paths
\prgNewFunction \brtObjElim {Mm}
    {\prgReturn {\propVarItem #1 {#2}}}

% The \brtObjNamed maps names to objects, not necessarily injectively.
% For each object, its @id= is a valid name for the object.
% \brtObjName {#1=name:str} #2=obj:obj -> void
\prgNewFunction \brtObjName {mM}
    {\tlConst {\expName {c__brt_obj_named_ #1}} #2}

% \brtObjNamed {#1=name:str} -> object named "name"
\prgNewFunction \brtObjNamed {m}
    {\prgReturn {\tlUse {\expName {c__brt_obj_named_ #1}}}}

% primitive type type (default formatter)
\propConstFromKeyval \brtTypeT {@id=Type}
\brtObjName {Type} {\brtTypeT}

% primitive integer type (formats to expl3 integer)
\brtObjName {Int} {\brtObjCons {@type = \brtObjNamed {Type}}}
\prgNewFunction \brtIntCons {m}
    {\prgReturn
        {\brtObjCons
            {@type = \brtObjNamed {Int},
             @value = {\__brt_make \intConst {#1}}}}}

% primitive string type (formats to expl3 string)
\brtObjName {Str} {\brtObjCons {@type = \brtObjNamed {Type}}}
\prgNewFunction \brtStrCons {m}
    {\prgReturn
        {\brtObjCons
            {@type = \brtObjNamed {Str},
             @value = {\__brt_make \strConst {#1}}}}}

% \brtObjFmtSet #1=obj:obj {#2=fmtr:fun} -> void
% Set the formatter for the object.
\prgNewFunction \__brt_obj_fmt_p {M}
    {\prgReturn {\expName {\evalWhole {__brt_obj_fmt_ \brtObjElim #1 {@id}}}}}
\prgNewFunction \brtObjFmtSet {Mn}
    {\__brt_fun_del {\__brt_obj_fmt_p #1}
     \prgNewFunction:Mnn {\__brt_obj_fmt_p #1} {M} {#2}}

% \brtObjFmt #1=obj:obj -> formatted object
\prgNewFunction \brtObjFmt {M}
    {\prgReturn {\evalWhole {{\__brt_obj_fmt_p #1} #1}}}

\brtObjFmtSet {\brtObjNamed {Type}} {\prgReturn {\tlToStr {\propToKeyval #1}}}

% \brtStrConcat
