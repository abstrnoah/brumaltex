% brumaltex2 - A compilation of LaTeX packages and macros used by the author.
%
% See the README.md file and comments below for documentation.
%
% Github: https://github.com/abstractednoah/brumaltex
% Author: Noah D. Ortiz <abstractednoah@brumal.org>


\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{brumaltex2}[2022/08/13]

% CORE PACKAGES AND COMMANDS %%{1

% Programming.
\RequirePackage{xparse}
\RequirePackage{xifthen}

% Standard maths library.
\RequirePackage{amsmath, amssymb, amsthm}
\RequirePackage{mathtools}
% This is the single most useful package.
\RequirePackage{physics}

% Fonts.
\RequirePackage{mathrsfs}
\RequirePackage{stmaryrd}
\RequirePackage{dsfont}
\RequirePackage{bm}

% A reasonable quotation interface.
\RequirePackage{csquotes}

% brt@thisIfThat %%{
% Expand #1 if #2 is not empty.
\DeclareRobustCommand{\brt@thisIfThat}[2]{%%
    \ifthenelse{\equal{#2}{}}{}{#1}%%
}
%%}

% OPTIONS %%{1

\DeclareOption{lists}{
    \RequirePackage{enumerate}
}

\DeclareOption{units}{
    \RequirePackage[load=accepted,load=prefixed,load=abbr]{siunitx}
}

\DeclareOption{frame}{
    \RequirePackage{fancyhdr}
    \RequirePackage{lastpage}
    \RequirePackage{microtype}

    % brtReloadHeader %%{
    % Run this anywhere to reset header after possible disruption.
    % TODO: find source (some stackoverflow) and understand what's happening
    \ifcsname f@nch@setoffs\endcsname\else
        \let\f@nch@setoffs\fancy@setoffs
    \fi
    \DeclareRobustCommand{\brtReloadHeader}{\f@nch@setoffs}
    %%}

    \brt@setupFrame
}

\DeclareOption{geometry}{
    \RequirePackage{fullpage}
}

\DeclareOption{datetime}{
    \RequirePackage{datetime2}
    \DTMusemodule{english}{en-NZ}
    \DTMsetstyle{en-NZ}
}

\DeclareOption{colours}{
    \RequirePackage{xcolor}
    \definecolor{blueish}{rgb}{0.0,0.1,0.4}
    \definecolor{greenish}{rgb}{0.0,0.4,0.0}
}


\DeclareOption{links}{
    \RequirePackage{varioref}
    \RequirePackage{hyperref}
    \RequirePackage[nameinlink]{cleveref}
    \ExecuteOptions{colours}
    \hypersetup{
        linktocpage,
        colorlinks=true,
        linkcolor=blueish,
        citecolor=greenish
    }

    % brtLinkFootnote{url}{text} %%{
    % Create a link to 'url' displayed as 'text' and with a footnote that
    % displays the actual url.
    %
    % We use href's '\hyper@normalise' to (hopefully) take care of escaping
    % arbitrary characters in the url, so that the user should not have to
    % escape them manually. It is important that the url is the first argument,
    % though with some more effort it's probably possible to work around that
    % limitation. See [^1].
    \newcommand{\brt@linkFootnote}[2]{\href{#1}{#2}\footnote{\url{#1}}}
    \DeclareRobustCommand{\brtLinkFootnote}{\hyper@normalise\brt@linkFootnote}
    %%}
}

\DeclareOption{nomathsbreak}{
    % Never ever break in maths mode.
    % TODO test, this might need to go into the begin hook
    \binoppenalty=\maxdimen
    \relpenalty=\maxdimen
    \sloppy
}

\DeclareOption{theorems}{
    \brt@setupTheorems
    \AtBeginDocument{
        \theoremstyle{plain}
    }
}

\DeclareOption{shorthand}{
    \brt@setupShorthand
}

\DeclareOption{graphics}{
    \RequirePackage{graphicx}
}

\DeclareOption{chemistry}{
    \RequirePackage[version=4]{mhchem}
}

% ENVIRONMENTS %%{1

% TODO reimplemenet configurable environment titles
% TODO fancy sub-proof proof

% All theorem counters, by default, are within the `theorem` counter, which is
% within `section`. To change counter dependency, use `\counterwithin` and
% friends.

\DeclareRobustCommand{\brt@setupTheorems}{
    \DeclareRobustCommand{\@brtProblemTitle}{Problem}

    \theoremstyle{plain}
    \newtheorem{theorem}{Theorem}[section]
    \newtheorem*{theorem*}{Theorem}
    \newtheorem{postulate}[theorem]{Postulate}
    \newtheorem{proposition}[theorem]{Proposition}
    \newtheorem*{proposition*}{Proposition}
    \newtheorem{lemma}[theorem]{Lemma}
    \newtheorem*{lemma*}{Lemma}
    \newtheorem{fact}[theorem]{Fact}
    \newtheorem*{fact*}{Fact}
    \newtheorem{claim}[theorem]{Claim}
    \newtheorem*{claim*}{Claim}
    \newtheorem{corollary}[theorem]{Corollary}
    \newtheorem*{corollary*}{Corollary}
    \newtheorem{problem}{\@brtProblemTitle}
    \newtheorem{subproblem}{Part}[problem]
    \newtheorem*{problem*}{\@brtProblemTitle}
    \newtheorem{want}[theorem]{Want}
    \newtheorem*{want*}{Want}

    \theoremstyle{definition}
    \newtheorem{definition}[theorem]{Definition}
    \newtheorem*{definition*}{Definition}
    \newtheorem{example}[theorem]{Example}
    \newtheorem{remark}[theorem]{Remark}
    \newtheorem*{remark*}{Remark}
    \newtheorem{axiom}[theorem]{Axiom}
    \newtheorem*{axiom*}{Axiom}
}

% SHORTHAND %%{1

\DeclareRobustCommand{\brt@setupShorthand}{
    % TODO make these commands optionally accept an argument and intelligently
    % determine whether brackets are needed.
    \ProvideDocumentCommand{\brtMaOperator}{m}{%%
        \textnormal{\textsf{#1}}%%
    }
    \ProvideDocumentCommand{\brtMaType}{m}{%%
        \textnormal{\textsf{\textbf{#1}}}%%
    }
    \ProvideDocumentCommand{\brtMaStatement}{m}{%%
        \textnormal{\texttt{\textbf{#1}}}%%
    }
    \ProvideDocumentCommand{\brtMaStructure}{m}{%%
        \textnormal{\textbb{#1}}%%
    }

    \NewCommandCopy{\category}{\brtMaType}

    % For when you define a new term.
    % TODO Eventually we should make this collect terms for an index (I believe
    % there's an issue where tectonic doesn't currently support indexes).
    \providecommand{\defn}[1]{\textbf{#1}}

    % When you want only one number for multi-line equation block.
    \providecommand{\nn}{\nonumber}

    \NewCommandCopy{\epsilonOld}{\epsilon}
    \NewCommandCopy{\varepsilonOld}{\varepsilon}
    \RenewCommandCopy{\epsilon}{\varepsilonOld}
    \RenewCommandCopy{\varepsilon}{\epsilonOld}

    \NewCommandCopy{\phiOld}{\phi}
    \NewCommandCopy{\varphiOld}{\varphi}
    \RenewCommandCopy{\phi}{\varphiOld}
    \RenewCommandCopy{\varphi}{\phiOld}

    \NewCommandCopy{\barOld}{\bar}
    \RenewCommandCopy{\bar}{\overline}

    \NewCommandCopy{\tildeOld}{\tilde}
    \RenewCommandCopy{\tilde}{\widetilde}

    \NewCommandCopy{\leqOld}{\leq}
    \RenewCommandCopy{\leq}{\leqslant}
    \NewCommandCopy{\geqOld}{\geq}
    \RenewCommandCopy{\geq}{\geqslant}

    \providecommand{\powerset}{\mathcal{P}}

    \DeclareDocumentCommand{\C}{}{\brtMaStructure{C}}
    \providecommand{\N}{\brtMaStructure{N}}
    \providecommand{\Q}{\brtMaStructure{Q}}
    \providecommand{\R}{\brtMaStructure{R}}
    \providecommand{\Z}{\brtMaStructure{Z}}

    % TODO i think there's a more idiomatic way of defining surroundings
    \providecommand{\buildset}[2]{\qty{\midqty{#1}{#2}}}
    \providecommand{\ceil}[1]{\left\lceil#1\right\rceil}
    \providecommand{\dummycdot}{\,\cdot\,}
    \providecommand{\floor}[1]{\left\lfloor#1\right\rfloor}
    \providecommand{\midqty}[2]{\left.#1\ \middle\vert\ #2\right.}
    \providecommand{\modqty}[2]{\left.#1\middle/#2\right.}

    \providecommand{\1}{\mathds{1}}
    \providecommand{\codom}{\brtMaOperator{codom}}
    \providecommand{\coker}{\brtMaOperator{coker}}
    \providecommand{\diam}{\brtMaOperator{diam}}
    \providecommand{\dist}{\brtMaOperator{dist}}
    \providecommand{\dom}{\brtMaOperator{dom}}
    \providecommand{\image}{\brtMaOperator{image}}
    \providecommand{\ker}{\brtMaOperator{ker}}
    \providecommand{\proj}{\brtMaOperator{proj}}
    \providecommand{\ran}{\brtMaOperator{ran}}
    \providecommand{\sgn}{\brtMaOperator{sgn}}
}

% PAGE STYLE %%{1

\DeclareRobustCommand{\brt@setupStyle}{
    \ProvideDocumentCommand{\brtTopic}{m}{%%
        \DeclareRobustCommand{\@brt@topic}{#1}%%
    }
    \ProvideDocumentCommand{\brtSubtitle}{m}{%%
        \DeclareRobustCommand{\@brt@subtitle}{#1}%%
    }
    \ProvideDocumentCommand{\brtShorttitle}{m}{%%
        \DeclareRobustCommand{\@brt@shorttitle}{#1}%%
    }
    \ProvideDocumentCommand{\brtContributors}{m}{%%
        \DeclareRobustCommand{\@brt@contributors}{#1}%%
    }

    \title{}
    \date{\today}
    \brtTopic{}
    \brtSubtitle{}
    \brtShorttitle{}
    \brtContributors{}

    \providecommand{\brtPageOfWord}{of}

    % Default page style.
    \fancypagestyle{brtStylePlain}{
        \setlength{\headheight}{15.2pt}
        \renewcommand{\headrulewidth}{0.8pt}
        \renewcommand{\footrulewidth}{0.8pt}
        \setlength{\headsep}{0.1in}

        \fancyhf{}
        \fancyhead[C]{\@title}
        \fancyhead[R]{\@author}
        \fancyfoot[L]{\@brt@topic}
        \fancyfoot[C]{\@date}
        \fancyfoot[R]{\thepage\ \brtPageOfWord\ \pageref{LastPage}}
    }

    % Page style for title page (no other content).
    \fancypagestyle{brtStyleTitlePage}{
        \renewcommand{\headrulewidth}{0pt}
        \renewcommand{\footrulewidth}{0pt}
        \fancyhf{}
        \fancyfoot[C]{\@date}
    }

    % Page style for page that has title and maybe other content.
    \fancypagestyle{brtStyleTitlePageWithContent}{
        \renewcommand{\headrulewidth}{0pt}
        \fancyhf{}
        \fancyfoot[C]{\@date}
        \fancyfoot[R]{\thepage\ \brtPageOfWord\ \pageref{LastPage}}
    }

    % brtMakeTitleText
    % Print the title text without external typesetting like headers, etc.
    \ProvideDocumentCommand{\brtMakeTitleText}{%%
        \begin{doublespace}
            \begin{center}%%
                \LARGE%%
                \@title%%
                \Large%%
                \brt@thisIfThat{\\\@brt@subtitle}{\@brt@subtitle}%%
                \large%%
                \\\@author%%
                \brt@thisIfThat{\\\@brt@contributors}{\@brt@contributors}%%
                \normalsize%%
                \\\@brt@topic%%
            \end{center}%%
        \end{doublespace}%%
    }

    % brtMakeTitlePage
    % Create a new page, put the title on it, and fix headers for title page.
    \ProvideDocumentCommand{\brtMakeTitlePage}{%%
        \thispagestyle{brtStyleTitlePage}
        \newpage{}%%
        \vspace*{3in}%%
        \brtMakeTitleText{}%%
    }

    % brtMakeTitle
    % Print the title on a page with possible other content, but change headers
    % accordingly.
    \ProvideDocumentCommand{\brtMakeTitle}{%%
        \thispagestyle{brtStyleTitlePageWithContent}
        \brtMakeTitleText{}%%
    }
}

% NOTES %%{1

% [^1]: https://tex.stackexchange.com/questions/12855/getting-those-signs-in-the-footnote


% We deviate from the default 'foldmarker' because it is not uncommon to have
% three curly brackets in a row in TeX.
% vim:ft=tex:fdm=marker:fmr=%%{,%%}:fen:tw=80:et:ts=4:sts=4:sw=0:
